{
  "version": "1.0",
  "workflow_name": "InvoiceProcessing_v1",
  "description": "LangGraph invoice processing with HITL checkpoint/resume and Bigtool tool selection.",
  "config": {
    "match_threshold": 0.90,
    "two_way_tolerance_pct": 5,
    "human_review_queue": "human_review_queue",
    "checkpoint_table": "checkpoints",
    "default_db": "sqlite:///./demo.db"
  },
  "inputs": {
    "invoice_payload": {
      "invoice_id": "string",
      "vendor_name": "string",
      "vendor_tax_id": "string",
      "invoice_date": "string",
      "due_date": "string",
      "amount": "number",
      "currency": "string",
      "line_items": [
        { "desc": "string", "qty": "number", "unit_price": "number", "total": "number" }
      ],
      "attachments": ["string"]
    }
  },
  "stages": [
    {
      "id": "INTAKE",
      "mode": "deterministic",
      "agent": "IngestNode",
      "instructions": "Validate payload schema, persist raw invoice payload and attachments metadata. Return raw_id and ingest timestamp.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "storage", "action": "select", "pool_hint": ["s3","gcs","local_fs"] },
        { "name": "DB", "config_ref": "{{DB_CONN}}" }
      ],
      "output_schema": {
        "raw_id": "string",
        "engest_ts": "string",
        "validated": "boolean"
      }
    },
    {
      "id": "UNDERSTAND",
      "mode": "deterministic",
      "agent": "OcrNlpNode",
      "instructions": "Run OCR on attachments, extract text and parse line items, normalize dates/currency, return parsed_invoice.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "ocr", "action": "select", "pool_hint": ["google_vision","tesseract","aws_textract"] },
        { "name": "NLPParser", "config_ref": "{{NLP_KEY}}" }
      ],
      "output_schema": {
        "parsed_invoice": {
          "invoice_text": "string",
          "parsed_line_items": "array",
          "detected_pos": "array",
          "currency": "string",
          "parsed_dates": { "invoice_date": "string", "due_date": "string" }
        }
      }
    },
    {
      "id": "PREPARE",
      "mode": "deterministic",
      "agent": "NormalizeEnrichNode",
      "instructions": "Normalize vendor name, enrich vendor profile and compute flags (risk, missing_info). Use Bigtool to pick enrichment provider.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "enrichment", "action": "select", "pool_hint": ["clearbit","people_data_labs","vendor_db"] },
        { "name": "COMMON_utils", "config_ref": "{{COMMON_KEY}}" }
      ],
      "output_schema": {
        "vendor_profile": { "normalized_name": "string", "tax_id": "string", "enrichment_meta": "object" },
        "normalized_invoice": { "amount": "number", "currency": "string", "line_items": "array" },
        "flags": { "missing_info": "array", "risk_score": "number" }
      }
    },
    {
      "id": "RETRIEVE",
      "mode": "deterministic",
      "agent": "ErpFetchNode",
      "instructions": "Fetch POs, GRNs and historical invoices from ERP/Procurement systems to find candidate matches.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "erp_connector", "action": "select", "pool_hint": ["sap_sandbox","netsuite","mock_erp"] },
        { "name": "ATLAS_client", "config_ref": "{{ATLAS_ERP_KEY}}" }
      ],
      "output_schema": {
        "matched_pos": "array",
        "matched_grns": "array",
        "history": "array"
      }
    },
    {
      "id": "MATCH_TWO_WAY",
      "mode": "deterministic",
      "agent": "TwoWayMatcherNode",
      "instructions": "Compute 2-way match score between invoice and PO. If match_score >= config.match_threshold set match_result='MATCHED' else 'FAILED'. Include tolerance analysis.",
      "tools": [
        { "name": "MatchEngine", "config_ref": "{{MATCH_KEY}}" },
        { "name": "COMMON_utils", "config_ref": "{{COMMON_KEY}}" }
      ],
      "output_schema": {
        "match_score": "number",
        "match_result": "string",
        "tolerance_pct": "number",
        "match_evidence": "object"
      }
    },
    {
      "id": "CHECKPOINT_HITL",
      "mode": "deterministic",
      "agent": "CheckpointNode",
      "instructions": "If match_result == 'FAILED' persist full state as a checkpoint (state_blob) in DB, create review ticket and push to human review queue. Return checkpoint_id and review_url. Pause workflow.",
      "trigger_condition": "input_state.match_result == 'FAILED'",
      "tools": [
        { "name": "BigtoolPicker", "capability": "db", "action": "select", "pool_hint": ["postgres","sqlite","dynamodb"] },
        { "name": "QueueService", "config_ref": "{{QUEUE_KEY}}" }
      ],
      "output_schema": {
        "checkpoint_id": "string",
        "review_url": "string",
        "paused_reason": "string"
      }
    },
    {
      "id": "HITL_DECISION",
      "mode": "non-deterministic",
      "agent": "HumanReviewNode",
      "instructions": "Await human decision via human-review API. Accept or Reject. On ACCEPT return resume_token and next_stage='RECONCILE'. On REJECT finalize with status 'MANUAL_HANDOFF'.",
      "tools": [
        { "name": "HumanUI", "config_ref": "{{APP_URL}}" },
        { "name": "Auth", "config_ref": "{{AUTH_KEY}}" }
      ],
      "output_schema": {
        "human_decision": "string",
        "reviewer_id": "string",
        "resume_token": "string",
        "next_stage": "string"
      }
    },
    {
      "id": "RECONCILE",
      "mode": "deterministic",
      "agent": "ReconciliationNode",
      "instructions": "If human accepted or invoice matched, create accounting entries (debits/credits) and reconciliation report.",
      "tools": [
        { "name": "AccountingEngine", "config_ref": "{{ACCT_KEY}}" },
        { "name": "COMMON_utils", "config_ref": "{{COMMON_KEY}}" }
      ],
      "output_schema": {
        "accounting_entries": "array",
        "reconciliation_report": "object"
      }
    },
    {
      "id": "APPROVE",
      "mode": "deterministic",
      "agent": "ApprovalNode",
      "instructions": "Apply approval policies (auto-approve under threshold, escalate above). Return approval_status and approver_id if escalated.",
      "tools": [
        { "name": "WorkflowEngine", "config_ref": "{{WF_KEY}}" }
      ],
      "output_schema": {
        "approval_status": "string",
        "approver_id": "string"
      }
    },
    {
      "id": "POSTING",
      "mode": "deterministic",
      "agent": "PostingNode",
      "instructions": "Post journal entries to ERP and schedule payment. Return posted flag and txn ids.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "erp_connector", "action": "select", "pool_hint": ["sap_sandbox","netsuite","mock_erp"] },
        { "name": "Payments", "config_ref": "{{PAY_KEY}}" }
      ],
      "output_schema": {
        "posted": "boolean",
        "erp_txn_id": "string",
        "scheduled_payment_id": "string"
      }
    },
    {
      "id": "NOTIFY",
      "mode": "deterministic",
      "agent": "NotifyNode",
      "instructions": "Send notifications to vendor and internal finance team (email/slack). Log notification statuses.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "email", "action": "select", "pool_hint": ["sendgrid","smartlead","ses"] },
        { "name": "Messaging", "config_ref": "{{SLACK_KEY}}" }
      ],
      "output_schema": {
        "notify_status": "object",
        "notified_parties": "array"
      }
    },
    {
      "id": "COMPLETE",
      "mode": "deterministic",
      "agent": "CompleteNode",
      "instructions": "Produce final payload and audit log entries. Mark workflow completed and persist audit to DB.",
      "tools": [
        { "name": "BigtoolPicker", "capability": "db", "action": "select", "pool_hint": ["postgres","sqlite","dynamodb"] }
      ],
      "output_schema": {
        "final_payload": "object",
        "audit_log": "array",
        "status": "string"
      }
    }
  ],
  "error_handling": {
    "retry_policy": { "max_retries": 3, "backoff_seconds": 2 },
    "on_unrecoverable_error": { "action": "persist_and_fail", "notify": ["ops_team"] }
  }
}
